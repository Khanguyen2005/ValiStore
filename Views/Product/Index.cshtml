@model ValiModern.Models.ViewModels.ProductIndexVM
@{
    ViewBag.Title = "Shop";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container my-4">
    <div class="row">
        <!-- Sidebar Filters -->
        <div class="col-lg-3 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filters</h5>
                </div>
                <div class="card-body">
                    <!-- Search -->
                    @using (Html.BeginForm("Index", "Product", FormMethod.Get, new { @class = "mb-3" }))
                    {
                        <input type="text" name="q" value="@Model.SearchQuery" class="form-control" placeholder="Search products..." />
                        @Html.Hidden("category", Model.CurrentCategory)
                        @Html.Hidden("brand", Model.CurrentBrand)
                        @Html.Hidden("sort", Model.CurrentSort)
                        <button type="submit" class="btn btn-primary w-100 mt-2"><i class="bi bi-search"></i> Search</button>
                    }

                    <!-- Categories -->
                    <div class="mb-3">
                        <h6 class="fw-bold mb-2">Categories</h6>
                        <ul class="list-unstyled">
                            <li class="mb-1">
                                <a href="@Url.Action("Index", new { q = Model.SearchQuery, brand = Model.CurrentBrand, sort = Model.CurrentSort })"
                                   class="text-decoration-none @(string.IsNullOrEmpty(Model.CurrentCategory) ? "fw-bold text-primary" : "")">
                                    All Categories
                                </a>
                            </li>
                            @foreach (var cat in Model.Categories)
                            {
                                <li class="mb-1">
                                    <a href="@Url.Action("Index", new { category = cat.name, q = Model.SearchQuery, brand = Model.CurrentBrand, sort = Model.CurrentSort })"
                                       class="text-decoration-none @(Model.CurrentCategory == cat.name ? "fw-bold text-primary" : "")">
                                        @cat.name
                                    </a>
                                </li>
                            }
                        </ul>
                    </div>

                    <!-- Brands -->
                    <div class="mb-3">
                        <h6 class="fw-bold mb-2">Brands</h6>
                        <ul class="list-unstyled">
                            <li class="mb-1">
                                <a href="@Url.Action("Index", new { category = Model.CurrentCategory, q = Model.SearchQuery, sort = Model.CurrentSort })"
                                   class="text-decoration-none @(string.IsNullOrEmpty(Model.CurrentBrand) ? "fw-bold text-primary" : "")">
                                    All Brands
                                </a>
                            </li>
                            @foreach (var brand in Model.Brands)
                            {
                                <li class="mb-1">
                                    <a href="@Url.Action("Index", new { category = Model.CurrentCategory, brand = brand.name, q = Model.SearchQuery, sort = Model.CurrentSort })"
                                       class="text-decoration-none @(Model.CurrentBrand == brand.name ? "fw-bold text-primary" : "")">
                                        @brand.name
                                    </a>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="col-lg-9">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2 class="h4 mb-0">Products</h2>
                    <small class="text-muted">@Model.TotalProducts products found</small>
                </div>

                <!-- Sort -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-sort-down me-1"></i> Sort By
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item @(string.IsNullOrEmpty(Model.CurrentSort) || Model.CurrentSort == "best_selling" ? "active" : "")"
                               href="@Url.Action("Index", new { category = Model.CurrentCategory, brand = Model.CurrentBrand, q = Model.SearchQuery })">Best Selling</a>
                        </li>
                        <li>
                            <a class="dropdown-item @(Model.CurrentSort == "newest" ? "active" : "")"
                               href="@Url.Action("Index", new { category = Model.CurrentCategory, brand = Model.CurrentBrand, q = Model.SearchQuery, sort = "newest" })">Newest</a>
                        </li>
                        <li>
                            <a class="dropdown-item @(Model.CurrentSort == "price_asc" ? "active" : "")"
                               href="@Url.Action("Index", new { category = Model.CurrentCategory, brand = Model.CurrentBrand, q = Model.SearchQuery, sort = "price_asc" })">Price: Low to High</a>
                        </li>
                        <li>
                            <a class="dropdown-item @(Model.CurrentSort == "price_desc" ? "active" : "")"
                               href="@Url.Action("Index", new { category = Model.CurrentCategory, brand = Model.CurrentBrand, q = Model.SearchQuery, sort = "price_desc" })">Price: High to Low</a>
                        </li>
                        <li>
                            <a class="dropdown-item @(Model.CurrentSort == "name_asc" ? "active" : "")"
                               href="@Url.Action("Index", new { category = Model.CurrentCategory, brand = Model.CurrentBrand, q = Model.SearchQuery, sort = "name_asc" })">Name: A-Z</a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Products -->
            @if (Model.Products != null && Model.Products.Any())
            {
                <div class="row g-3">
                    @foreach (var product in Model.Products)
                    {
                        <div class="col-md-6 col-lg-4">
                            <div class="card h-100 shadow-sm product-card">
                                @if (product.HasDiscount)
                                {
                                    <span class="badge bg-danger position-absolute top-0 end-0 m-2">-@product.DiscountPercent%</span>
                                }
                                <a href="@Url.Action("Details", new { id = product.id })">
                                    <img src="@product.image_url" class="card-img-top" alt="@product.name" style="height:200px;object-fit:cover;" />
                                </a>
                                <div class="card-body d-flex flex-column">
                                    <h6 class="card-title text-truncate" title="@product.name">@product.name</h6>
                                    <div class="mt-auto">
                                        <div class="d-flex align-items-center mb-2">
                                            @if (product.HasDiscount)
                                            {
                                                <span class="text-muted text-decoration-line-through me-2">@String.Format("{0:n0}", product.original_price) ₫</span>
                                            }
                                            <span class="fw-bold text-primary fs-5">@String.Format("{0:n0}", product.price) ₫</span>
                                        </div>
                                        <small class="text-muted"><i class="bi bi-bag-check me-1"></i>Sold: @product.sold</small>
                                        <a href="@Url.Action("Details", new { id = product.id })" class="btn btn-primary w-100 mt-2">
                                            <i class="bi bi-eye me-1"></i>View Details
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Pagination -->
                if (Model.TotalPages > 1)
                {
                    <nav class="mt-4">
                        <ul class="pagination justify-content-center">
                            @if (Model.CurrentPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Index", new { category = Model.CurrentCategory, brand = Model.CurrentBrand, q = Model.SearchQuery, sort = Model.CurrentSort, page = Model.CurrentPage - 1 })">Previous</a>
                                </li>
                            }

                            @for (int i = 1; i <= Model.TotalPages; i++)
                            {
                                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                    <a class="page-link" href="@Url.Action("Index", new { category = Model.CurrentCategory, brand = Model.CurrentBrand, q = Model.SearchQuery, sort = Model.CurrentSort, page = i })">@i</a>
                                </li>
                            }

                            @if (Model.CurrentPage < Model.TotalPages)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Index", new { category = Model.CurrentCategory, brand = Model.CurrentBrand, q = Model.SearchQuery, sort = Model.CurrentSort, page = Model.CurrentPage + 1 })">Next</a>
                                </li>
                            }
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>No products found. Try adjusting your filters.
                </div>
            }
        </div>
    </div>
</div>

<style>
    .product-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
</style>
