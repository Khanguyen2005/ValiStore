@model ValiModern.Models.ViewModels.UserOrderDetailsVM
@{
    ViewBag.Title = "Order Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="~/Content/OrderDetails.css" rel="stylesheet" />
}

<div class="container my-5">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 order-details-header">
        <div>
            <h2 class="h3 mb-2 fw-bold">Order @Model.OrderCode</h2>
            <small class="text-muted d-flex align-items-center">
                <i class="bi bi-calendar3 me-2"></i>
                Placed on @Model.OrderDate.ToString("dd MMMM yyyy 'at' HH:mm")
            </small>
        </div>
        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Orders
        </a>
    </div>

    <!-- Delivery Success Alert (shown only when shipper delivered) -->
    @if (Model.ShowDeliveryNotification && Model.Status != "Completed")
    {
        <div class="alert alert-success alert-dismissible fade show border-0 shadow-sm mb-4" role="alert">
            <div class="d-flex align-items-start">
                <i class="bi bi-check-circle-fill me-3 fs-3"></i>
                <div class="flex-grow-1">
                    <h5 class="alert-heading fw-bold mb-2">
                        <i class="bi bi-truck me-2"></i>Your Order Has Been Delivered!
                    </h5>
                    <p class="mb-3">
                        Great news! Your order was successfully delivered by our shipper 
                        <strong>@(!string.IsNullOrEmpty(Model.ShipperName) ? Model.ShipperName : "N/A")</strong> 
                        on <strong>@Model.DeliveredAt.Value.ToString("dd MMM yyyy 'at' HH:mm")</strong>.
                    </p>
                    @if (!string.IsNullOrEmpty(Model.DeliveryNote))
                    {
                        <div class="alert alert-light mb-3">
                            <strong><i class="bi bi-sticky me-2"></i>Delivery Note:</strong>
                            <p class="mb-0 mt-2">@Model.DeliveryNote</p>
                        </div>
                    }
                    <hr class="my-3" />
                    <p class="mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        If you have received your order, please confirm below to complete the transaction.
                    </p>
                    <button type="button" class="btn btn-success btn-lg px-4" data-bs-toggle="modal" data-bs-target="#confirmReceivedModal">
                        <i class="bi bi-check2-circle me-2"></i>Confirm Received
                    </button>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row g-4">
        <!-- Order Status & Info -->
        <div class="col-lg-8">
            <!-- Status Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0 fw-bold">
                            <i class="bi bi-truck me-2"></i>Order Status
                        </h5>
                        @switch (Model.Status)
                        {
                            case "Pending":
                                <span class="badge bg-warning text-dark fs-6 px-4 py-2 rounded-pill">
                                    <i class="bi bi-clock me-1"></i>Pending
                                </span>
                                break;
                            case "Confirmed":
                                <span class="badge bg-info fs-6 px-4 py-2 rounded-pill">
                                    <i class="bi bi-check-circle me-1"></i>Confirmed
                                </span>
                                break;
                            case "Shipped":
                                <span class="badge bg-primary fs-6 px-4 py-2 rounded-pill">
                                    <i class="bi bi-truck me-1"></i>Shipped
                                </span>
                                break;
                            case "Completed":
                                <span class="badge bg-success fs-6 px-4 py-2 rounded-pill">
                                    <i class="bi bi-check-all me-1"></i>Completed
                                </span>
                                break;
                            case "Cancelled":
                                <span class="badge bg-danger fs-6 px-4 py-2 rounded-pill">
                                    <i class="bi bi-x-circle me-1"></i>Cancelled
                                </span>
                                break;
                            default:
                                <span class="badge bg-secondary fs-6 px-4 py-2 rounded-pill">@Model.Status</span>
                                break;
                        }
                    </div>

                    <!-- Order Timeline -->
                    <div class="order-timeline mt-4">
                        <div class="timeline-step @(Model.Status == "Pending" || Model.Status == "Confirmed" || Model.Status == "Shipped" || Model.Status == "Completed" ? "completed" : "")">
                            <div class="timeline-icon">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-title">Order Placed</div>
                                <div class="timeline-date">@Model.CreatedAt.ToString("dd MMM yyyy, HH:mm")</div>
                            </div>
                        </div>

                        <div class="timeline-step @(Model.Status == "Confirmed" || Model.Status == "Shipped" || Model.Status == "Completed" ? "completed" : "")">
                            <div class="timeline-icon">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-title">Order Confirmed</div>
                                @if (Model.Status == "Confirmed" || Model.Status == "Shipped" || Model.Status == "Completed")
                                {
                                    <div class="timeline-date">@Model.UpdatedAt.ToString("dd MMM yyyy, HH:mm")</div>
                                }
                                else
                                {
                                    <div class="timeline-date text-muted">Waiting for confirmation</div>
                                }
                            </div>
                        </div>

                        <div class="timeline-step @(Model.Status == "Shipped" || Model.Status == "Completed" ? "completed" : "")">
                            <div class="timeline-icon">
                                <i class="bi bi-truck"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-title">Order Shipped</div>
                                @if (Model.Status == "Shipped" || Model.Status == "Completed")
                                {
                                    <div class="timeline-date">@Model.UpdatedAt.ToString("dd MMM yyyy, HH:mm")</div>
                                    if (Model.DeliveredAt.HasValue)
                                    {
                                        <div class="text-success small mt-1">
                                            <i class="bi bi-check2 me-1"></i>Delivered: @Model.DeliveredAt.Value.ToString("dd MMM yyyy, HH:mm")
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="timeline-date text-muted">Not shipped yet</div>
                                }
                            </div>
                        </div>

                        <div class="timeline-step @(Model.Status == "Completed" ? "completed" : "")">
                            <div class="timeline-icon">
                                <i class="bi bi-check-all"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-title">Order Completed</div>
                                @if (Model.Status == "Completed")
                                {
                                    <div class="timeline-date">@Model.UpdatedAt.ToString("dd MMM yyyy, HH:mm")</div>
                                }
                                else
                                {
                                    <div class="timeline-date text-muted">Not completed yet</div>
                                }
                            </div>
                        </div>
                    </div>

                    @if (Model.CanCancel)
                    {
                        <div class="mt-4 pt-4 border-top">
                            <button type="button" class="btn btn-outline-danger btn-lg" data-bs-toggle="modal" data-bs-target="#cancelOrderModal">
                                <i class="bi bi-x-circle me-2"></i>Cancel Order
                            </button>
                        </div>
                    }
                </div>
            </div>

            <!-- Order Items -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-box-seam me-2"></i>Order Items (@Model.Items.Count)
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 100px" class="ps-4">Image</th>
                                    <th>Product</th>
                                    <th style="width: 200px">Variant</th>
                                    <th style="width: 150px" class="text-center">Price</th>
                                    <th style="width: 100px" class="text-center">Qty</th>
                                    <th style="width: 150px" class="text-end pe-4">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.Items)
                                {
                                    <tr>
                                        <td class="ps-4">
                                            @if (!string.IsNullOrEmpty(item.ProductImageUrl))
                                            {
                                                <img src="@Url.Content("~" + item.ProductImageUrl)" 
                                                     alt="@item.ProductName" 
                                                     class="rounded shadow-sm" 
                                                     style="width: 70px; height: 70px; object-fit: cover;" />
                                            }
                                            else
                                            {
                                                <div class="bg-light d-flex align-items-center justify-content-center rounded" 
                                                     style="width: 70px; height: 70px;">
                                                    <i class="bi bi-image text-muted fs-4"></i>
                                                </div>
                                            }
                                        </td>
                                        <td>
                                            <a href="@Url.Action("Details", "Product", new { id = item.ProductId })" 
                                               class="text-decoration-none text-dark fw-semibold">
                                                @item.ProductName
                                            </a>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(item.ColorName) || !string.IsNullOrEmpty(item.SizeName))
                                            {
                                                <div class="d-flex flex-column gap-1">
                                                    @if (!string.IsNullOrEmpty(item.ColorName))
                                                    {
                                                        <div class="d-inline-flex align-items-center">
                                                            @if (!string.IsNullOrEmpty(item.ColorCode))
                                                            {
                                                                <span class="color-swatch me-2" style="background-color: @item.ColorCode;"></span>
                                                            }
                                                            <small class="text-muted">@item.ColorName</small>
                                                        </div>
                                                    }
                                                    @if (!string.IsNullOrEmpty(item.SizeName))
                                                    {
                                                        <span class="badge bg-light text-dark border">
                                                            <i class="bi bi-rulers me-1"></i>@item.SizeName
                                                        </span>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <span class="fw-semibold">
                                                @item.Price.ToString("N0") <span class="currency">đ</span>
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-primary rounded-pill px-3 py-2">@item.Quantity</span>
                                        </td>
                                        <td class="text-end pe-4">
                                            <strong class="text-success fs-6">
                                                @item.Subtotal.ToString("N0") <span class="currency">đ</span>
                                            </strong>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="border-top bg-light">
                                <tr>
                                    <td colspan="5" class="text-end pe-4 py-3">
                                        <strong class="fs-5">Total:</strong>
                                    </td>
                                    <td class="text-end pe-4 py-3">
                                        <strong class="text-success fs-4">
                                            @Model.TotalAmount.ToString("N0") <span class="currency">đ</span>
                                        </strong>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Shipping Info -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-geo-alt me-2"></i>Shipping Information
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="info-group mb-3 pb-3 border-bottom">
                        <label class="text-muted small text-uppercase mb-2 d-block">
                            <i class="bi bi-telephone me-1"></i>Phone Number
                        </label>
                        <div class="fw-bold fs-6">@Model.Phone</div>
                    </div>
                    <div class="info-group">
                        <label class="text-muted small text-uppercase mb-2 d-block">
                            <i class="bi bi-pin-map me-1"></i>Delivery Address
                        </label>
                        <div class="fw-bold fs-6">@Model.ShippingAddress</div>
                    </div>
                </div>
            </div>

            <!-- Payment Info -->
            @if (Model.Payments.Any())
            {
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-success text-white py-3">
                        <h5 class="mb-0 fw-bold">
                            <i class="bi bi-credit-card me-2"></i>Payment Information
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        @foreach (var payment in Model.Payments)
                        {
                            <div class="payment-item @(Model.Payments.Count > 1 && !payment.Equals(Model.Payments.Last()) ? "mb-3 pb-3 border-bottom" : "")">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="payment-method">
                                        <i class="bi bi-credit-card-2-front me-2 text-muted"></i>
                                        <strong class="fs-6">@payment.PaymentMethod</strong>
                                    </div>
                                    @if (payment.Status == "Completed")
                                    {
                                        <span class="badge bg-success px-3 py-2 rounded-pill">
                                            <i class="bi bi-check-circle me-1"></i>Paid
                                        </span>
                                    }
                                    else if (payment.Status == "Pending")
                                    {
                                        <span class="badge bg-warning text-dark px-3 py-2 rounded-pill">
                                            <i class="bi bi-clock me-1"></i>Pending
                                        </span>
                                    }
                                    else if (payment.Status == "Failed")
                                    {
                                        <span class="badge bg-danger px-3 py-2 rounded-pill">
                                            <i class="bi bi-x-circle me-1"></i>Failed
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary px-3 py-2 rounded-pill">@payment.Status</span>
                                    }
                                </div>
                                
                                <div class="payment-details">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">Amount:</span>
                                        <strong class="text-success fs-6">@payment.Amount.ToString("N0") đ</strong>
                                    </div>
                                    
                                    @if (!string.IsNullOrEmpty(payment.TransactionId))
                                    {
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="text-muted">Transaction ID:</span>
                                            <code class="small bg-light px-2 py-1 rounded">@payment.TransactionId</code>
                                        </div>
                                    }
                                    
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">Date:</span>
                                        <span class="small">@payment.PaymentDate.ToString("dd MMM yyyy, HH:mm")</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold" id="cancelOrderModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>Cancel Order
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <p class="fs-6 mb-3">Are you sure you want to cancel this order?</p>
                <div class="alert alert-warning border-0 shadow-sm">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-exclamation-triangle me-3 fs-4"></i>
                        <div>
                            <strong class="d-block mb-1">Important Note:</strong>
                            <small>This action cannot be undone. The product stock will be automatically restored.</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                    <i class="bi bi-x me-2"></i>No, Keep Order
                </button>
                @using (Html.BeginForm("Cancel", "Order", new { id = Model.OrderId }, FormMethod.Post))
                {
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger px-4">
                        <i class="bi bi-check2 me-2"></i>Yes, Cancel Order
                    </button>
                }
            </div>
        </div>
    </div>
</div>

<!-- Confirm Received Modal -->
<div class="modal fade" id="confirmReceivedModal" tabindex="-1" aria-labelledby="confirmReceivedModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white border-0">
                <h5 class="modal-title fw-bold" id="confirmReceivedModalLabel">
                    <i class="bi bi-check-circle me-2"></i>Confirm Order Received
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <i class="bi bi-box-seam text-success" style="font-size: 4rem;"></i>
                </div>
                <h6 class="fw-bold mb-3 text-center">Have you received your order in good condition?</h6>
                <p class="text-muted text-center mb-4">
                    By confirming, you acknowledge that your order <strong>@Model.OrderCode</strong> 
                    has been delivered successfully and you are satisfied with the products.
                </p>
                <div class="alert alert-info border-0 shadow-sm">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-info-circle me-3 fs-4"></i>
                        <div>
                            <strong class="d-block mb-1">Please Note:</strong>
                            <small>Once confirmed, this order will be marked as <strong>Completed</strong> and cannot be cancelled.</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                    <i class="bi bi-x me-2"></i>Not Yet
                </button>
                @using (Html.BeginForm("ConfirmReceived", "Order", new { id = Model.OrderId }, FormMethod.Post))
                {
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-success px-4">
                        <i class="bi bi-check2-circle me-2"></i>Yes, I Received It
                    </button>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto show delivery notification modal if needed (optional)
        @if (Model.ShowDeliveryNotification && Model.Status != "Completed")
        {
            <text>
            $(document).ready(function() {
                // Optional: Auto-show modal after 2 seconds
                // setTimeout(function() {
                //     $('#confirmReceivedModal').modal('show');
                // }, 2000);
            });
            </text>
        }
    </script>
}
