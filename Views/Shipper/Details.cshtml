@model ValiModern.Models.ViewModels.ShipperOrderDetailsVM
@{
    ViewBag.Title = "Order #" + Model.OrderId;
    Layout = "~/Views/Shared/_ShipperLayout.cshtml";
    var googleMapsUrl = string.Format("https://www.google.com/maps/dir/?api=1&destination={0}", Uri.EscapeDataString(Model.ShippingAddress));
}

@section Styles {
<link href="~/Content/shipper_details.css" rel="stylesheet" />
}

<!-- Header -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h2 class="h4 fw-bold mb-0">
                <i class="bi bi-box-seam me-2 text-success"></i>Order #@Model.OrderId
            </h2>
            <div class="d-flex gap-2">
                @if (!Model.IsDelivered)
                {
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#markDeliveredModal">
                        <i class="bi bi-check-circle me-1"></i>Mark Delivered
                    </button>
                }
                <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Bar -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <a href="tel:@Model.Phone" class="quick-action-btn bg-primary">
            <i class="bi bi-telephone-fill"></i>
            <small>Call Customer</small>
        </a>
    </div>
    <div class="col-6 col-md-3">
        <button onclick="openChat()" class="quick-action-btn bg-info">
            <i class="bi bi-chat-dots-fill"></i>
            <small>Chat Now</small>
        </button>
    </div>
    <div class="col-6 col-md-3">
        <a href="@googleMapsUrl" target="_blank" class="quick-action-btn bg-danger">
            <i class="bi bi-geo-alt-fill"></i>
            <small>Navigate</small>
        </a>
    </div>
    <div class="col-6 col-md-3">
        <button onclick="copyAddress()" class="quick-action-btn bg-warning">
            <i class="bi bi-clipboard-fill"></i>
            <small>Copy Address</small>
        </button>
    </div>
</div>

<!-- Delivery Timer & Progress -->
@if (!Model.IsDelivered)
{
    <div class="row mb-4">
        <div class="col-12">
            <div class="shipper-card border-warning">
                <div class="text-center mb-3">
                    <small class="text-muted d-block mb-2">
                        <i class="bi bi-clock me-1"></i>Time Since Assignment
                    </small>
                    <div class="delivery-timer" id="deliveryTimer">00:00:00</div>
                    <small class="text-muted">@Model.AssignedAt.ToString("dd/MM/yyyy HH:mm")</small>
                </div>
                
                <!-- Delivery Progress Animation -->
                <div class="delivery-progress-container">
                    <div class="progress-bar-custom">
                        <div class="progress-fill" id="progressFill"></div>
                        <div class="progress-truck" id="progressTruck">
                            <i class="bi bi-truck"></i>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-muted"><i class="bi bi-shop"></i> Warehouse</small>
                        <small class="text-muted"><i class="bi bi-house-door"></i> Customer</small>
                    </div>
                    <div class="text-center mt-2">
                        <small class="delivery-status-text" id="statusText">Preparing delivery...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Main Content -->
<div class="row g-4">
    <!-- Order & Customer Info -->
    <div class="col-lg-6">
        <div class="shipper-card mb-4">
            <h6 class="fw-bold mb-3"><i class="bi bi-info-circle me-2 text-success"></i>Order Info</h6>
            <table class="table table-sm table-borderless">
                <tr><td class="text-muted">Order ID:</td><td><strong>#@Model.OrderId</strong></td></tr>
                <tr><td class="text-muted">Date:</td><td>@Model.OrderDate.ToString("dd/MM/yyyy HH:mm")</td></tr>
                <tr><td class="text-muted">Status:</td><td><span class="badge bg-primary">@Model.Status</span></td></tr>
                <tr><td class="text-muted">Amount:</td><td><strong class="text-success">@Model.TotalAmount.ToString("N0") đ</strong></td></tr>
            </table>
        </div>
        
        <div class="shipper-card">
            <h6 class="fw-bold mb-3"><i class="bi bi-person me-2 text-info"></i>Customer</h6>
            <table class="table table-sm table-borderless">
                <tr><td class="text-muted">Name:</td><td><strong>@Model.CustomerName</strong></td></tr>
                <tr><td class="text-muted">Phone:</td><td><a href="tel:@Model.Phone">@Model.Phone</a></td></tr>
                <tr><td class="text-muted">Address:</td><td id="deliveryAddress">@Model.ShippingAddress</td></tr>
            </table>
        </div>
    </div>

    <!-- Google Maps -->
    <div class="col-lg-6">
        <div class="shipper-card">
            <h6 class="fw-bold mb-3"><i class="bi bi-map me-2 text-danger"></i>Location</h6>
            <div class="ratio ratio-16x9 mb-3 rounded overflow-hidden">
                <iframe src="https://maps.google.com/maps?q=@Uri.EscapeDataString(Model.ShippingAddress)&output=embed" allowfullscreen></iframe>
            </div>
            <a href="@googleMapsUrl" target="_blank" class="btn btn-danger w-100">
                <i class="bi bi-signpost-2 me-1"></i>Get Directions
            </a>
        </div>
    </div>

    <!-- Delivery Status -->
    <div class="col-12">
        <div class="shipper-card @(Model.IsDelivered ? "border-success" : "border-warning") border-2">
            <h6 class="fw-bold mb-3"><i class="bi bi-truck me-2"></i>Delivery Status</h6>
            @if (Model.IsDelivered)
            {
                <div class="alert alert-success">
                    <strong><i class="bi bi-check-circle me-2"></i>Delivered:</strong> @Model.DeliveredAt.Value.ToString("dd/MM/yyyy HH:mm")
                    @if (!string.IsNullOrEmpty(Model.DeliveryNote))
                    {
                        <hr class="my-2" />
                        <div>@Model.DeliveryNote</div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>Not delivered yet
                </div>
                <button type="button" class="btn btn-success btn-lg w-100" data-bs-toggle="modal" data-bs-target="#markDeliveredModal">
                    <i class="bi bi-check-circle me-2"></i>Mark as Delivered
                </button>
            }
        </div>
    </div>

    <!-- Order Items -->
    <div class="col-12">
        <div class="shipper-card">
            <h6 class="fw-bold mb-3"><i class="bi bi-box me-2"></i>Items (@Model.TotalQuantity units)</h6>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr><th>Product</th><th>Variant</th><th>Qty</th><th>Price</th><th>Total</th></tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Items)
                        {
                            <tr>
                                <td>@item.ProductName</td>
                                <td>
                                    @if (!string.IsNullOrEmpty(item.ColorName))
                                    {
                                        <small>@item.ColorName</small>
                                    }
                                    @if (!string.IsNullOrEmpty(item.SizeName))
                                    {
                                        <span class="badge bg-secondary ms-1">@item.SizeName</span>
                                    }
                                </td>
                                <td>@item.Quantity</td>
                                <td>@item.Price.ToString("N0") đ</td>
                                <td><strong>@item.Subtotal.ToString("N0") đ</strong></td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="table-light">
                        <tr><td colspan="4" class="text-end"><strong>Total:</strong></td><td><strong class="text-success">@Model.TotalAmount.ToString("N0") đ</strong></td></tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Mark Delivered Modal -->
<div class="modal fade" id="markDeliveredModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-check-circle me-2"></i>Mark Delivered</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="@Url.Action("MarkDelivered", new { id = Model.OrderId })" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Delivery Note (Optional)</label>
                        <textarea name="deliveryNote" class="form-control" rows="3" maxlength="500" placeholder="E.g., Delivered to security, left at door..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Proof Photos (Optional)</label>
                        <input type="file" name="deliveryPhotos" class="form-control" accept="image/*" multiple capture="environment" onchange="previewPhotos(event)" />
                        <div id="photoPreview" class="mt-2"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Confirm Delivery</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Chat Modal -->
<div class="modal fade" id="chatModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="bi bi-chat-dots me-2"></i>Chat with @Model.CustomerName</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="text-center text-muted">
                            <i class="bi bi-chat-dots fs-2 mb-2"></i>
                            <p>Start a conversation with your customer!</p>
                        </div>
                    </div>
                    <div class="chat-input-group">
                        <input type="text" id="chatInput" class="form-control" placeholder="Type message..." maxlength="500" />
                        <button onclick="sendMessage()" class="btn btn-info"><i class="bi bi-send-fill"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
<!-- SignalR Scripts -->
@Scripts.Render("~/bundles/signalr")
<script src="~/signalr/hubs"></script>
<script src="~/Scripts/chat-signalr.js"></script>
<script src="~/Scripts/shipper_details.js"></script>
<script>
    // Globals
    var ORDER_ID = @Model.OrderId;
    var USER_ID = @(User.Identity.IsAuthenticated ? User.Identity.Name : "null");
    var ASSIGNED_AT = '@Model.AssignedAt.ToString("yyyy-MM-ddTHH:mm:ss")';
    var DELIVERY_ADDRESS = '@Html.Raw(Model.ShippingAddress.Replace("'", "\\'"))';
    var IS_DELIVERED = @Model.IsDelivered.ToString().ToLower();
    
    // Initialize
    if (!IS_DELIVERED) {
        startDeliveryTimer(ASSIGNED_AT);
        startDeliveryProgressAnimation();
    }
</script>
}
